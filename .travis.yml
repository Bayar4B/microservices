language: java

env:
  - NODE_VERSION="12.13.1"
  
services:
  - docker

addons:
  sonarcloud:
    organization: "bayar4b" # the key of the org you chose at step #3
    token: 
      secure: "Iq0YHp7ZCTGD8U89SIfF2mm8hCretK2yP6ACNsKx0qP4BmMgk60dmRTtPQZNkRdawCPcxsvpEIK3+eKbY1F+F5cpNmDdI6P3d8poJvqVW9+DjigV8Tvlzz4Pk0S8o4nIOy3UosF6sMXR7gF02KlWTaYWBAIbJgrRyUkB/0Z3UYQqORq0//7oY4Q+xKGMI6syjKwcUbhTQjdTFVEIRzeQ0MLi9aeeMw2mla+eA7OtpVz0uYKv9M2YKX0gvsOYqoiryULBPq+MEkkmVyz87kSJz7qQRIbULh6HPPAZzeJL9GAvlj5xd5FMu28R4WDuZIM9mofUI7Ctkw2Fc6uX3t2yQiF1FNiuiIlbTP1ZAk2hzR/d4A4907Zk8wtN1D64W9nqxR0hVIb0lgdKHhyxUy/93tPt1j8D7O3C/D89qgF3y3CUxXXd3Vq5jm2IgaoAhlqH7Yd7zdxhaHhjg6J4KHQqdRVn7DgCA+fZd4Q0qV92uJ5m4Jb7WTNW46BKrtF7KFNe1HffuPEpGc4/p7P74ZTucgGepUsOJO8PRnaYFdYKtEkzARUINFxP1zMGlIk6WJfp2b3UoZTxWfbxaec9XRdhTUhTnXBAdNAdnA4S9d0xace08mmR9PYGeBLwUYMGoeedWOYfzcTKyQ7XRa6Vl24+v7NJ1kXQUKlAtfBOiM/NZpc="
script:
  # the following command line builds the project, runs the tests with coverage and then execute the SonarCloud analysis
  - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent install sonar:sonar -Dsonar.projectKey=Bayar4B_microservices

cache:
    directories:
      - .autoconf
      - $HOME/.m2
      - node_modules

jobs:
  include:
    - stage: Prepare
      script:
      - nvm install $NODE_VERSION
      - mvn install -N -DskipTests=true -Dmaven.javadoc.skip=true -B -V
    - stage : Build
      script:
      - mvn install -Ppackage-docker-image  
      - echo "$DOCKER_USERNAME"
      - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
      - docker tag unige/api-gateway bayar4b/api-gateway:latest
      - docker tag unige/regulatory-service bayar4b/regulatory-service:latest
      - docker tag unige/valuation-service bayar4b/valuation-service:latest
      - docker tag unige/instrument-service bayar4b/instrument-service:latest
      - docker tag unige/counterparty-service bayar4b/counterparty-service:latest     
      - docker push bayar4b/api-gateway:latest
      - docker push bayar4b/regulatory-service:latest
      - docker push bayar4b/valuation-service:latest
      - docker push bayar4b/instrument-service:latest
      - docker push bayar4b/counterparty-service:latest
      - mvn sonar:sonar -Dsonar.projectKey=Bayar4B_microservices -Dsonar.organization=bayar4b -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=$SONAR_TOKEN     
    - stage : Build
      script:
      - cd web-ui
      - pwd
      - npm -v
      - npm install
      - npm update
      - npm run-script build --prod
      - docker build -t unige/web-ui .
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin      
      - docker tag unige/web-ui bayar4b/web-ui:latest      
      - docker push bayar4b/web-ui:latest
